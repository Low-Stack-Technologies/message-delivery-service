openapi: 3.0.3
info:
  title: Message Delivery Service
  description: |
    A service to provide email and SMS sending capabilities to other services through a simple REST API. 
    Built using Node.js, Express, and Zod.
  version: 2.0.0
servers:
  - url: http://localhost:3000
    description: Local Docker environment

# Security Definition
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  
  schemas:
    # --- Shared Schemas ---
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: "Invalid credentials"
      required:
        - success
        - message

    # --- Authentication Schemas ---
    AuthRequest:
      type: object
      properties:
        service:
          type: string
          description: The name of the service requesting access.
        password:
          type: string
          format: password
        totp:
          type: string
          description: Time-based One-Time Password.
      required:
        - service
        - password
        - totp

    AuthResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Authenticated successfully"
        data:
          type: object
          properties:
            jwt:
              type: string
              description: The JWT token to be used in subsequent requests.
      required:
        - success
        - message
        - data

    # --- Email Schemas ---
    EmailRecipient:
      type: object
      properties:
        name:
          type: string
        email:
          type: string
          format: email
      required:
        - email

    EmailRequestBase:
      type: object
      properties:
        to:
          type: string
          format: email
        from:
          $ref: '#/components/schemas/EmailRecipient'
        subject:
          type: string
      required:
        - to
        - from
        - subject

    # logic: if useTemplate is false
    EmailRequestRaw:
      allOf:
        - $ref: '#/components/schemas/EmailRequestBase'
        - type: object
          properties:
            useTemplate:
              type: boolean
              enum: [false]
            body:
              type: string
            isHTML:
              type: boolean
          required:
            - useTemplate
            - body
            - isHTML

    # logic: if useTemplate is true
    EmailRequestTemplate:
      allOf:
        - $ref: '#/components/schemas/EmailRequestBase'
        - type: object
          properties:
            useTemplate:
              type: boolean
              enum: [true]
            template:
              type: object
              properties:
                name:
                  type: string
                data:
                  type: object
                  additionalProperties:
                    type: string
              required:
                - name
                - data
          required:
            - useTemplate
            - template

    # --- SMS Schemas ---
    SmsRecipientObject:
      type: object
      properties:
        phone:
          type: string
        country:
          type: string
          description: Two-letter country code (e.g., SE, US).
          minLength: 2
          maxLength: 2
      required:
        - phone
        - country

    SmsRequestBase:
      type: object
      properties:
        to:
          oneOf:
            - type: string
              description: Phone number as a string.
            - $ref: '#/components/schemas/SmsRecipientObject'
        from:
          type: object
          properties:
            name:
              type: string
          required:
            - name
      required:
        - to
        - from

    # logic: if useTemplate is false
    SmsRequestRaw:
      allOf:
        - $ref: '#/components/schemas/SmsRequestBase'
        - type: object
          properties:
            useTemplate:
              type: boolean
              enum: [false]
            body:
              type: string
          required:
            - useTemplate
            - body

    # logic: if useTemplate is true
    SmsRequestTemplate:
      allOf:
        - $ref: '#/components/schemas/SmsRequestBase'
        - type: object
          properties:
            useTemplate:
              type: boolean
              enum: [true]
            template:
              type: object
              properties:
                name:
                  type: string
                data:
                  type: object
                  additionalProperties:
                    type: string
              required:
                - name
                - data
          required:
            - useTemplate
            - template

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Operation successful"
      required:
        - success
        - message

    SmsSuccessResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            cost:
              type: object
              properties:
                currency:
                  type: string
                  example: "SEK"
                amount:
                  type: number
                  format: float
                  description: Cost in 10000ths of the currency.
                  example: 0.35

paths:
  /v2/authenticate:
    post:
      summary: Authenticate Service
      description: Exchange service credentials for a JWT.
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRequest'
      responses:
        '200':
          description: Successful authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v2/email:
    post:
      summary: Send Email
      tags:
        - Email
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/EmailRequestRaw'
                - $ref: '#/components/schemas/EmailRequestTemplate'
      responses:
        '200':
          description: Email sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Validation or sending error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v2/sms:
    post:
      summary: Send SMS
      tags:
        - SMS
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/SmsRequestRaw'
                - $ref: '#/components/schemas/SmsRequestTemplate'
      responses:
        '200':
          description: SMS sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SmsSuccessResponse'
        '400':
          description: Invalid phone number or validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'